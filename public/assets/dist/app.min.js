(function() {
	'use strict';
	
	angular.module('rdApp', ['ngRoute']);

})();

(function() {
	'use strict';

	angular.module('rdApp', '')
		.config(function($routeProvider, $locationProvider) {
			$routeProvider
				.when('/', {
					templateUrl: '/app/contacts/default.html'
				})
				.when('/edit/:id', {
					templateUrl: '/app/contacts/edit.html',
					controller: 'EditController as vm'
				})
				.when('/add', {
					templateUrl: '/app/contacts/edit.html',
					controller: 'AddController as vm'
				})
				.otherwise({
					redirectTo: '/'
				});

			$locationProvider.html5Mode(true);
		});

})();

(function() {
	'use strict';
	
	angular.module('rdApp')
		.controller('AddController', addContact);

	function addContact() {
		/* jshint validthis: true */
		var vm = this;
		vm.titlePrefix = 'Add';
	}

})();

(function() {
	'use strict';
	
	angular.module('rdApp')
		.controller('EditController', viewContact);

	function viewContact($location, $routeParams, contactsService) {
		/* jshint validthis: true */
		var vm = this;
		vm.titlePrefix = 'Edit';
		vm.showDelete = true;
		vm.id = $routeParams.id;
		vm.deleteContact = deleteContact;

		getContact(vm.id);

		function deleteContact() {
			console.log('clicked');
			var confirm = window.confirm('You are about to delete the contact for ' + vm.contact.fullName + '. Press OK to confirm.');

			if (confirm) {
				return contactsService.deleteContact(vm.id)
					.then(function(data) {
						alert('The contact for ' + vm.contact.fullName + ' has been deleted.');
						$location.path('/');
					});
			}
		}

		function getContact(id) {
			return contactsService.getContact(id)
				.then(function(data) {
					vm.contact = data.data;
					vm.contact.fullName = vm.contact.firstName + ' ' + vm.contact.lastName;
					return vm.contact;
				});
		}
	}

})();

(function() {
	'use strict';
	
	angular.module('rdApp')
		.controller('ListController', listContacts);

	function listContacts($rootScope) {
		// Do stuff
		$rootScope.selectedContactId = '5522134c2aa3c0b86c6f497e';
	}

})();

(function() {
	'use strict';

	angular.module('rdApp')
		.controller('SecondaryController', SecondaryController);

	function SecondaryController($location, $routeParams, $scope, contactsService) {
		/* jshint validthis: true */
		var vm = this;
		vm.isCurrentPage = isCurrentPage;
		vm.activeItem = null;

		getContacts();

		$scope.$watch(function() {
				return $location.path();
			}, function(path) {
				if (path === '/') {
					vm.activeItem = null;
				}
			}
		);

		function getContacts() {
			return contactsService.getContacts()
				.then(function(data) {
					vm.contacts = data.data;
					return vm.contacts;
				});
		}

		function isCurrentPage(id) {
			var location = $location.path();

			// Is 'add' page?
			if (id === 'tbd' && location.substr(1) === 'add') {
				return true;
			}
			// Does slug match this id?
			else if (typeof $routeParams.id !== null && $routeParams.id === id) {
				return true;
			}

			return false;
		}
	}

})();

(function() {
	'use strict';
	
	angular.module('rdApp')
		.directive('rdSecondary', secondary);

	function secondary() {
		return {
			restrict: 'A',
			templateUrl: 'app/contacts/secondary.html',
			controller: 'SecondaryController',
			controllerAs: 'vm'
		};
	}

})();

(function() {
	'use strict';
	
	angular.module('rdApp')
		.factory('contactsService', contactsService);

	function contactsService($http, $q) {
		var retrieveContacts = function() {
			return $http({
				method: 'GET',
				url: '/api/contacts/'
			});
		};

		var retrieveContact = function(id) {
			return $http({
				method: 'GET',
				url: '/api/contacts/' + id
			});	
		};

		var removeContact = function(id) {
			return $http({
				method: 'DELETE',
				url: '/api/contacts/' + id
			});		
		};

		return {
			getContacts: function() {
				return retrieveContacts();
			},
			getContact: function(id) {
				return retrieveContact(id);
			},
			deleteContact: function(id) {
				return removeContact(id);
			}
		};
	}

})();
